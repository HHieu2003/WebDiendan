<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bài viết: <%= post.title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .flash-message-container {
      width: 300px;
      max-width: 100%;
    }
    .alert {
      font-size: 1rem;
      padding: 1rem;
      border-radius: 8px;
    }
    .media-preview {
      max-width: 200px;
      margin: 5px;
    }
    .media-container {
      display: flex;
      flex-wrap: wrap;
    }
    .media-preview {
  object-fit: cover;
  max-height: 200px;
}
.media-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

  </style>
</head>
<body>
  <%- include('partials/navbar', { isAuthenticated: isAuthenticated, userRole: userRole, notifications: notifications }) %>
  <div class="container mt-5 pt-5">
    <!-- Thông báo Flash -->
    <div class="flash-message-container position-fixed top-0 end-0 p-3" style="z-index: 1050;">
      <% if (success_msg && success_msg.length > 0) { %>
        <div id="successAlert" class="alert alert-success alert-dismissible fade show shadow" role="alert">
          <%= success_msg %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>
      <% if (error_msg && error_msg.length > 0) { %>
        <div id="errorAlert" class="alert alert-danger alert-dismissible fade show shadow" role="alert">
          <%= error_msg %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>
    </div>
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <h2 class="card-title mb-3"><i class="bi bi-file-text"></i>Bài viết:  <%= post.title %></h2>
        <p class="text-muted mb-2">
          <i class="bi bi-person-circle"></i> <strong>Người đăng:</strong> <%= post.user ? post.user.name : 'Không xác định' %> |
          <i class="bi bi-calendar-event"></i> <strong>Ngày đăng:</strong> <%= new Date(post.createdAt).toLocaleString() %>
        </p>
    
        <p class="card-text"><strong>Nội dung: </strong><%= post.content %></p>
    
        <!-- Ảnh -->
        <% if (post.images && post.images.length > 0) { %>
          <div class="media-container mt-3 d-flex flex-wrap gap-2">
            <% post.images.forEach(image => { %>
              <img src="<%= image %>" class="media-preview rounded border" alt="Image" style="max-width: 200px;">
            <% }) %>
          </div>
        <% } %>
    
        <!-- Video -->
        <% if (post.videos && post.videos.length > 0) { %>
          <div class="media-container mt-3 d-flex flex-wrap gap-3">
            <% post.videos.forEach(video => { %>
              <video src="<%= video %>" class="media-preview border rounded" controls style="max-width: 300px;"></video>
            <% }) %>
          </div>
        <% } %>
    
        <!-- Tệp -->
        <% if (post.files && post.files.length > 0) { %>
          <div class="mt-3">
            <% post.files.forEach(file => { %>
              <a href="<%= file %>" target="_blank" class="btn btn-outline-secondary btn-sm me-2 mb-2">
                <i class="bi bi-paperclip"></i> <%= file.split('/').pop() %>
              </a>
            <% }) %>
          </div>
        <% } %>
    
        <!-- Quyền xóa -->
        <% if (
          (userRole === 'teacher' && forum.teacher && forum.teacher._id.toString() === req.userId) ||
          userRole === 'admin' ||
          (post.user && post.user._id.toString() === req.userId)
        ) { %>
          <a href="/forum/topic/<%= forumId %>/post/<%= post._id %>/delete" class="btn btn-danger mt-3">
            <i class="bi bi-trash"></i> Xóa bài viết
          </a>
        <% } %>
      </div>
    </div>
    
    <h3 class="mb-3"><i class="bi bi-chat-left-dots"></i> Bình luận</h3>
    
    <% if (comments.length === 0) { %>
      <p>Chưa có bình luận nào.</p>
    <% } else { %>
      <div class="mb-4">
        <% comments.forEach(comment => { %>
          <div class="card mb-3 shadow-sm">
            <div class="card-body">
              <div class="row">
                <!-- Cột nội dung bên trái -->
                <div class="col-10">
                  <p class="mb-1">
                    <strong><i class="bi bi-person"></i> <%= comment.user ? comment.user.name : 'Không xác định' %></strong> |
                    <small class="text-muted"><%= new Date(comment.createdAt).toLocaleString() %></small>
                  </p>
                  <p class="card-text"><%= comment.content %></p>
      
                  <% if (comment.images && comment.images.length > 0) { %>
                    <div class="media-container mt-2 d-flex flex-wrap gap-2">
                      <% comment.images.forEach(image => { %>
                        <img src="<%= image %>" class="media-preview rounded border" alt="Image" style="max-width: 180px;">
                      <% }) %>
                    </div>
                  <% } %>
      
                  <% if (comment.videos && comment.videos.length > 0) { %>
                    <div class="media-container mt-2 d-flex flex-wrap gap-3">
                      <% comment.videos.forEach(video => { %>
                        <video src="<%= video %>" class="media-preview rounded border" controls style="max-width: 300px;"></video>
                      <% }) %>
                    </div>
                  <% } %>
      
                  <% if (comment.files && comment.files.length > 0) { %>
                    <div class="mt-2">
                      <% comment.files.forEach(file => { %>
                        <a href="<%= file %>" target="_blank" class="btn btn-outline-secondary btn-sm me-2 mb-2">
                          <i class="bi bi-paperclip"></i> <%= file.split('/').pop() %>
                        </a>
                      <% }) %>
                    </div>
                  <% } %>
                </div>
      
                <!-- Cột nút bên phải -->
                <div class="col-2 text-end">
                  <div class="d-flex flex-column align-items-end gap-2">
                    <% if ((userRole === 'teacher' && forum.teacher && forum.teacher._id.toString() === req.userId) || 
                          userRole === 'admin' || 
                          (comment.user && comment.user._id.toString() === req.userId)) { %>
                      <a href="/forum/topic/<%= forumId %>/post/<%= post._id %>/delete-comment/<%= comment._id %>" 
                         class="btn btn-danger btn-sm w-100">
                        <i class="bi bi-trash"></i> Xóa
                      </a>
                    <% } %>
                    <% if (isAuthenticated) { %>
                      <form action="/forum/topic/<%= forumId %>/post/<%= post._id %>/comment/<%= comment._id %>/report" method="POST" class="w-100">
                        <button type="submit" class="btn btn-warning btn-sm w-100">
                          <i class="bi bi-flag"></i> Báo cáo
                        </button>
                      </form>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
      
    <% } %>
    <% if (isAuthenticated) { %>
      <h4 class="mb-3"><i class="bi bi-pencil-square"></i> Thêm bình luận</h4>

      <form action="/forum/topic/<%= forumId %>/post/<%= post._id %>/comment" method="POST" enctype="multipart/form-data" id="commentForm" class="needs-validation" novalidate>
        <!-- Nội dung -->
        <div class="mb-3">
          <textarea class="form-control" id="content" name="content" rows="3" placeholder="Nhập nội dung bình luận..." required></textarea>
          <div class="invalid-feedback">Vui lòng nhập nội dung bình luận.</div>
        </div>
      
        <!-- Tệp -->
        <div class="d-flex flex-wrap align-items-start gap-3 mb-3">
          <!-- Ảnh -->
          <div>
            <label for="images" class="btn btn-outline-secondary btn-sm" data-bs-toggle="tooltip" title="Thêm ảnh">
              <i class="bi bi-image"></i>
            </label>
            <input type="file" id="images" name="images" accept="image/jpeg,image/png,image/gif" multiple hidden>
            <div id="imagePreview" class="media-container mt-2"></div>
          </div>
      
          <!-- Video -->
          <div>
            <label for="videos" class="btn btn-outline-secondary btn-sm" data-bs-toggle="tooltip" title="Thêm video">
              <i class="bi bi-camera-reels"></i>
            </label>
            <input type="file" id="videos" name="videos" accept="video/mp4,video/mpeg,video/webm" multiple hidden>
            <div id="videoPreview" class="media-container mt-2"></div>
          </div>
      
          <!-- File -->
          <div>
            <label for="files" class="btn btn-outline-secondary btn-sm" data-bs-toggle="tooltip" title="Thêm tệp">
              <i class="bi bi-paperclip"></i>
            </label>
            <input type="file" id="files" name="files" accept=".pdf,.txt,.doc,.docx" multiple hidden>
            <div id="filePreview" class="media-container mt-2"></div>
          </div>
        </div>
      
        <!-- Gửi -->
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-send"></i> Gửi
        </button>
      </form>
      
    <% } %>
  </div>
  <%- include('partials/footer') %>
  <script>
    // Bootstrap validation
    document.getElementById('commentForm')?.addEventListener('submit', function(event) {
      const form = this;
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    });

    // Tự động ẩn thông báo flash sau 5 giây
    setTimeout(() => {
      ['successAlert', 'errorAlert'].forEach(id => {
        const alert = document.getElementById(id);
        if (alert) {
          const bsAlert = new bootstrap.Alert(alert);
          bsAlert.close();
        }
      });
    }, 5000);

    // Preview images
    document.getElementById('images')?.addEventListener('change', function(e) {
      const preview = document.getElementById('imagePreview');
      preview.innerHTML = '';
      for (const file of e.target.files) {
        const reader = new FileReader();
        reader.onload = event => {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.classList.add('media-preview');
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    });

    // Preview videos
    document.getElementById('videos')?.addEventListener('change', function(e) {
      const preview = document.getElementById('videoPreview');
      preview.innerHTML = '';
      for (const file of e.target.files) {
        const reader = new FileReader();
        reader.onload = event => {
          const video = document.createElement('video');
          video.src = event.target.result;
          video.classList.add('media-preview');
          video.controls = true;
          preview.appendChild(video);
        };
        reader.readAsDataURL(file);
      }
    });

    // Preview files
    document.getElementById('files')?.addEventListener('change', function(e) {
      const preview = document.getElementById('filePreview');
      preview.innerHTML = '';
      for (const file of e.target.files) {
        const p = document.createElement('p');
        p.textContent = file.name;
        preview.appendChild(p);
      }
    });
  </script>
</body>
</html>